<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Course Registration</title>
  <link rel="stylesheet" href="index.css" />
</head>
<body>
  <div class="sidebar">
    <div class="menu-title">Menu</div>
    <a href="dashboard.html">Home</a>
    <a class="active" href="registration1.html">Course Registration</a>
    <a href="timetable.html">Student Timetable</a>
    <button class="logout" id="logoutBtn">Logout</button>
  </div>

  <div class="content">
    <h2>Course Registration</h2>

    <input id="search" class="search" placeholder="Search course by code or name..." />

    <table class="table" id="courseTable">
      <thead>
        <tr>
          <th>Code</th>
          <th>Course</th>
          <th>Credits</th>
          <th>Day</th>
          <th>Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <script type="module">
  import { loadCSV } from "./loadCSV.js";

  const username = localStorage.getItem("username") || "guest";
  const REG_KEY = `reg_${username}`;               // lưu section_id đã đăng ký của user
  const DELTA_KEY = `delta_enrolled`;              // lưu tăng/giảm sĩ số do đăng ký local (demo)

    const courses = await loadCSV("./Courses (1).csv");
    const sections = await loadCSV("./Sections (1).csv");
    const enrollments = await loadCSV("");

  // ---------- Helpers ----------
  const getRegs = () => JSON.parse(localStorage.getItem(REG_KEY) || "[]");
  const setRegs = (arr) => localStorage.setItem(REG_KEY, JSON.stringify(arr));

  const getDelta = () => JSON.parse(localStorage.getItem(DELTA_KEY) || "{}");
  const setDelta = (obj) => localStorage.setItem(DELTA_KEY, JSON.stringify(obj));

  // base enrolled count from Enrollments.csv
  const baseEnrolledCount = new Map();
  for (const e of enrollments) {
    const sid = e.section_id;
    if (!sid) continue;
    baseEnrolledCount.set(sid, (baseEnrolledCount.get(sid) || 0) + 1);
  }

  const toMinutes = (hhmm) => {
    const [h, m] = hhmm.split(":").map(Number);
    return h * 60 + m;
  };

  // "07:00-09:40" => [420, 580]
  const parseTimeRange = (range) => {
    const [start, end] = range.split("-").map(s => s.trim());
    return [toMinutes(start), toMinutes(end)];
  };

  const overlap = (aStart, aEnd, bStart, bEnd) => Math.max(aStart, bStart) < Math.min(aEnd, bEnd);

  const getSectionById = (id) => sections.find(s => s.section_id === id);

  const getCourseById = (cid) => courses.find(c => c.course_id === cid);

  const getCurrentEnrolled = (sectionId) => {
    const base = baseEnrolledCount.get(sectionId) || 0;
    const delta = getDelta()[sectionId] || 0;
    return base + delta;
  };

  const incEnrolled = (sectionId, diff) => {
    const d = getDelta();
    d[sectionId] = (d[sectionId] || 0) + diff;
    if (d[sectionId] === 0) delete d[sectionId];
    setDelta(d);
  };

  // ---------- UI Render ----------
  const tbody = document.querySelector("#courseTable tbody");
  const search = document.getElementById("search");

  function render(filterText = "") {
    const regs = new Set(getRegs());
    const q = filterText.trim().toLowerCase();

    tbody.innerHTML = "";

    for (const sec of sections) {
      const c = getCourseById(sec.course_id);
      if (!c) continue;

      const hay = `${c.course_id} ${c.course_name} ${sec.section_id}`.toLowerCase();
      if (q && !hay.includes(q)) continue;

      const isReg = regs.has(sec.section_id);

      const cap = Number(sec.capacity || 0);
      const enrolledNow = getCurrentEnrolled(sec.section_id);
      const left = Math.max(0, cap - enrolledNow);

      const btnLabel = isReg ? "Drop" : "Register";
      const btnClass = isReg ? "btn danger" : "btn";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.course_id}</td>
        <td>${c.course_name}</td>
        <td>${c.credits}</td>
        <td>${sec.day}</td>
        <td>${sec.time}</td>
        <td>
          <div style="display:flex; gap:8px; justify-content:center; align-items:center;">
            <button class="${btnClass}" data-sec="${sec.section_id}" data-action="${isReg ? "drop" : "reg"}">
              ${btnLabel}
            </button>
            <span style="font-size:12px; color:#555;">${enrolledNow}/${cap} (${left} left)</span>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  // ---------- Business checks ----------
  function checkCapacity(sectionId) {
    const sec = getSectionById(sectionId);
    const cap = Number(sec.capacity || 0);
    const enrolledNow = getCurrentEnrolled(sectionId);
    return enrolledNow < cap;
  }

  function checkTimeConflict(newSectionId) {
    const newSec = getSectionById(newSectionId);
    if (!newSec) return { ok: true };

    const [ns, ne] = parseTimeRange(newSec.time);
    const regs = getRegs();

    for (const sid of regs) {
      const oldSec = getSectionById(sid);
      if (!oldSec) continue;

      if (oldSec.day !== newSec.day) continue;

      const [os, oe] = parseTimeRange(oldSec.time);
      if (overlap(ns, ne, os, oe)) {
        return {
          ok: false,
          conflictWith: sid,
          day: newSec.day,
          timeA: newSec.time,
          timeB: oldSec.time
        };
      }
    }
    return { ok: true };
  }

  // ---------- Actions ----------
  function doRegister(sectionId) {
    const regs = getRegs();
    if (regs.includes(sectionId)) return;

    // capacity
    if (!checkCapacity(sectionId)) {
      alert("Lớp đã đủ sĩ số (capacity full)!");
      return;
    }

    // time conflict
    const tc = checkTimeConflict(sectionId);
    if (!tc.ok) {
      alert(`Trùng lịch: ${tc.day} (${tc.timeA}) trùng với lớp đã đăng ký (${tc.conflictWith} - ${tc.timeB})`);
      return;
    }

    regs.push(sectionId);
    setRegs(regs);
    incEnrolled(sectionId, +1);

    render(search.value);
    alert("Đăng ký thành công (demo)!");
  }

  function doDrop(sectionId) {
    let regs = getRegs();
    if (!regs.includes(sectionId)) return;

    regs = regs.filter(x => x !== sectionId);
    setRegs(regs);
    incEnrolled(sectionId, -1);

    render(search.value);
    alert("Đã hủy đăng ký (demo)!");
  }

  // ---------- Events ----------
  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;

    const sectionId = btn.dataset.sec;
    const action = btn.dataset.action;

    if (action === "reg") doRegister(sectionId);
    else doDrop(sectionId);
  });

  search.addEventListener("input", () => render(search.value));

  // first render
  render();

  // logout
  document.getElementById("logoutBtn")?.addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "index.html";
  });
</script>
